# 服务器端 DNS 失效解决方案

最近遇见了一件奇怪的事情，我的虚拟机 DNS 总是不知道为什么就突然不工作了。之前碰到这种情况也没有在意，不过最近越来越频繁了，决定还是好好找下原因，彻底解决这个问题。

## 本地环境

* windows 10
* vagrant
* centos7

## 报错情况

长时间不操作电脑的话，等下次拉取代码的时候直接报错：

```bash
[vagrant@localhost example]$ git pull origin master
ssh: Could not resolve hostname git.example.com: Name or service not known
fatal: Could not read from remote repository.

Please make sure you have the correct access rights
and the repository exists.
```

Name or service not known，看到这种报错第一反应是 DNS 出问题了？紧接着测试下：

```bash
[vagrant@localhost example]$ ping baidu.com
ping: baidu.com: Name or service not known

[vagrant@localhost example]$ ping 8.8.8.8
PING 8.8.8.8 (8.8.8.8) 56(84) bytes of data.
64 bytes from 8.8.8.8: icmp_seq=1 ttl=51 time=66.3 ms
64 bytes from 8.8.8.8: icmp_seq=2 ttl=51 time=63.4 ms
64 bytes from 8.8.8.8: icmp_seq=3 ttl=51 time=63.4 ms
64 bytes from 8.8.8.8: icmp_seq=4 ttl=51 time=63.4 ms
```

果然不出所料，DNS 出问题了。但是虚拟机一直运行着，什么也没干，为什么突然就不行了呢？既然发现了是 DNS 有问题，那如何解决呢？

## 先解决问题

1. 查看本机 DNS 信息

```bash
[vagrant@localhost example]$ cat /etc/resolv.conf
# Generated by NetworkManager
nameserver 10.0.2.3
```

10.0.2.3 这是个什么鬼？公司自己的 DNS 服务器？不管了，直接换掉。

2. 更换 DNS 信息

```bash
# 查看网络配置文件
[vagrant@localhost example]$ sudo cat /etc/sysconfig/network-scripts/ifcfg-eth1
#VAGRANT-BEGIN
# The contents below are automatically generated by Vagrant. Do not modify.
NM_CONTROLLED=yes
BOOTPROTO=none
ONBOOT=yes
IPADDR=192.168.33.10
NETMASK=255.255.255.0
DEVICE=eth1
PEERDNS=no
#VAGRANT-END

# 新增 DNS 配置，将下面两行加入配置文件中
# DNS1=114.114.114.114
# DNS2=8.8.8.8
[vagrant@localhost example]$ sudo vim /etc/sysconfig/network-scripts/ifcfg-eth1

# 修改后的配置文件内容如下
[vagrant@localhost example]$ sudo cat /etc/sysconfig/network-scripts/ifcfg-eth1
#VAGRANT-BEGIN
# The contents below are automatically generated by Vagrant. Do not modify.
NM_CONTROLLED=yes
BOOTPROTO=none
ONBOOT=yes
IPADDR=192.168.33.10
NETMASK=255.255.255.0
DEVICE=eth1
DNS1=114.114.114.114
DNS2=8.8.8.8
PEERDNS=no # 注意这行配置，增加 "PEERDNS=no"，使 DNS 不受网卡的管控，不让 DHCP 服务自动分配 DNS。
#VAGRANT-END

# 同上，将 eth0 等网络配置也修改下，这里不再赘述

# 重启网络
[vagrant@localhost example]$ sudo systemctl restart network

# 测试
[vagrant@localhost example]$ ping baidu.com
PING baidu.com (220.181.38.148) 56(84) bytes of data.
64 bytes from 220.181.38.148 (220.181.38.148): icmp_seq=1 ttl=52 time=37.3 ms
64 bytes from 220.181.38.148 (220.181.38.148): icmp_seq=2 ttl=52 time=26.8 ms
```
OK，大功告成。

## 为什么出现这种情况？

我猜测因为之前网络配置中我并没有指定 DNS，然后 DHCP 服务会自动给我分配 DNS。在公司内网环境下，DNS 什么的应该都是走公司自己的服务。每次中午休息时间电脑就会进入休眠，然后再次打开时，网络会重新进行分配，但是我的虚拟机里面并没有变，所以用之前分配的 DNS 就不起作用了。

以上纯属猜测，毕竟我对网络也了解。为了避免误人子弟，就比瞎比比了，如果你也碰到了我这种情况，不妨试试上面的解决方案，亲测有效！

## 参考链接

[CentOS7.4 修改 /etc/resolv.conf 重启 network 后又恢复到原来的状态?](https://blog.51cto.com/meiling/2476526)