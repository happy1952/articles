# 解决 vagrant default: Warning: Authentication failure. Retrying... 问题

我们经常会使用 `vagrant package` 命令将我们的运行环境打包，然后在新的环境下加载我们打包的 box 文件。可是当我们使用 `vagrant up` 启动时，就会出现下面这种情况：

```bash
$ vagrant up
Bringing machine 'default' up with 'virtualbox' provider...
==> default: Importing base box 'centos/7'...
==> default: Matching MAC address for NAT networking...
==> default: Setting the name of the VM: centos_default_1662173902128_39172
==> default: Clearing any previously set network interfaces...
==> default: Preparing network interfaces based on configuration...
    default: Adapter 1: nat
    default: Adapter 2: hostonly
==> default: Forwarding ports...
    default: 22 (guest) => 2222 (host) (adapter 1)
==> default: Running 'pre-boot' VM customizations...
==> default: Booting VM...
==> default: Waiting for machine to boot. This may take a few minutes...
    default: SSH address: 127.0.0.1:2222
    default: SSH username: vagrant
    default: SSH auth method: private key
    default: Warning: Authentication failure. Retrying...
    default: Warning: Authentication failure. Retrying...
    default: Warning: Authentication failure. Retrying...
    default: Warning: Authentication failure. Retrying...
    default: Warning: Authentication failure. Retrying...
    default: Warning: Authentication failure. Retrying...
    default: Warning: Authentication failure. Retrying...
    default: Warning: Authentication failure. Retrying...
    default: Warning: Authentication failure. Retrying...
    default: Warning: Authentication failure. Retrying...
    default: Warning: Authentication failure. Retrying...
    default: Warning: Authentication failure. Retrying...
    default: Warning: Authentication failure. Retrying...
    default: Warning: Authentication failure. Retrying...
    default: Warning: Authentication failure. Retrying...
    default: Warning: Authentication failure. Retrying...
    default: Warning: Authentication failure. Retrying...
    default: Warning: Authentication failure. Retrying...
    default: Warning: Authentication failure. Retrying...
    default: Warning: Authentication failure. Retrying...
    default: Warning: Authentication failure. Retrying...
    default: Warning: Authentication failure. Retrying...
    default: Warning: Authentication failure. Retrying...
    default: Warning: Authentication failure. Retrying...
    default: Warning: Authentication failure. Retrying...
    default: Warning: Authentication failure. Retrying...
    default: Warning: Authentication failure. Retrying...
Timed out while waiting for the machine to boot. This means that
Vagrant was unable to communicate with the guest machine within
the configured ("config.vm.boot_timeout" value) time period.

If you look above, you should be able to see the error(s) that
Vagrant had when attempting to connect to the machine. These errors
are usually good hints as to what may be wrong.

If you're using a custom box, make sure that networking is properly
working and you're able to connect to the machine. It is a common
problem that networking isn't setup properly in these boxes.
Verify that authentication configurations are also setup properly,
as well.

If the box appears to be booting properly, you may want to increase
the timeout ("config.vm.boot_timeout") value.
```

可以看到，系统在使用 SSH 免密登录时不断的提示 Warning: Authentication failure. Retrying...，为什么会出现这种情况呢？

一般是因为 SSH 免密登录时是使用公钥、私钥进行密钥认证，而在我们在打包 box 时，虚拟机里面的私钥是和打包时本地环境里的公钥配对的，而在新的环境下加载 box 时，新环境下的公钥和虚拟机里面的私钥无法匹配，所以就会出现上面的情况，Vagrant 一直在进行登录尝试。

知道了症状，那我们现在来开药方。既然是公钥、私钥不匹配，那我们改成一对就可以了，具体操作步骤如下:

```bash
# 进入 Vagrantfile 同级目录下，执行 `vagrant ssh-config` 查看私钥所在位置。注意：虚拟机必须是启动状态 (`vagrant up`)
$ vagrant ssh-config
Host default
  HostName 127.0.0.1
  User vagrant
  Port 2222
  UserKnownHostsFile /dev/null
  StrictHostKeyChecking no
  PasswordAuthentication no
  IdentityFile D:/work/centos/.vagrant/machines/default/virtualbox/private_key # 这个目录就是私钥的位置
  IdentitiesOnly yes
  LogLevel FATAL

# 根据私钥生成对应的公钥文件
ssh-keygen -yf D:/work/centos/.vagrant/machines/default/virtualbox/private_key > public_key

# 查看公钥
$ cat public_key
ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQCeJjXWakcsm9KzI7/XckZMFt346+mQuo+8/wKqFftsaS3Siky3GnPOqXQclH/D/O3jrvllpyAXD4hOZxZfc+4VUTBJc/bB4rTCfUsDGWfkSHvtZVuEnPrnQ3I0eydHysBgNo5jYjaQPtwodtHDZb1rJHeRL4fXghMy1toZzqwkTh5MDGEvl0hHaVrzrXnYYKgNy7TF3XgR6KpCxZ7CjnKvl1z18tNR11fXlI5ghePzJmGuueKUaJMit29/mC6Vz2zCM5+QstqoiLFI/PM86ESmdupNANLGN4fVn1SCIprNxwVWjvzEE1+LSa6v7VIhKk0e4yNOxzGG2TEUmrnxS8Wp
```

好了，公钥生成好了，现在就只剩把虚拟机里面旧的公钥替换掉就 OK 了。具体操作如下：

在开始之前，因为我们的虚拟机默认是没有开启账号密码登录的，所以我们要先打开虚拟机，这里我用的是 VirtualBox，打开之后输入账号密码进行登录。Vagrant 默认的用户名密码都是：vagrant。

```bash
# 登录 Linux 系统，编辑 sshd_config 文件
# 将 #PermitRootLogin yes 前面的注释去掉，同时将 PasswordAuthentication 的值改成 yes。
[vagrant@localhost ~]$ sudo vim /etc/ssh/sshd_config 

# 编辑完成之后重启 sshd 服务
[vagrant@localhost ~]$ sudo systemctl restart sshd.service
```

这时，我们就可以在 Windows 本地通过 SSH 客户端工具去连接虚拟机了。登录成功后，就可以通过复制粘贴将我们刚才新生成的公钥复制到 `/home/vagrant/.ssh/authorized_keys` 里面，保存退出后执行下 `vagrant reload` 重启虚拟机。

当系统再次启动成功后，我们就可以使用 `vagrant ssh` 登录到 Linux 系统了，而不需要使用账户密码登录了。
